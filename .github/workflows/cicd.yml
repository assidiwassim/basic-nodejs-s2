name: CI/CD of basic-nodejs-s2

on:
  push:
    branches: [ "main" ]

jobs:

  build-and-push:
    
    runs-on: ubuntu-latest
   
    steps:
    
      - name: Clone code from github
        uses: actions/checkout@v4

      - name: build docker image
        run: docker build -t basic-nodejs-s2-image:latest .
      
      - name: tag docker image
        run: docker tag basic-nodejs-s2-image:latest ${{ secrets.DOCKERHUB_USERNAME }}/basic-nodejs-s2-image:latest

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: push docker image to docker hub
        run: docker push ${{ secrets.DOCKERHUB_USERNAME }}/basic-nodejs-s2-image:latest 


  test:

      needs: ["build-and-push"]

      runs-on: ubuntu-latest

      steps:
    
        - name: Login to Docker Hub
          uses: docker/login-action@v3
          with:
            username: ${{ secrets.DOCKERHUB_USERNAME }}
            password: ${{ secrets.DOCKERHUB_TOKEN }}

        - name: pull image
          run: docker pull ${{ secrets.DOCKERHUB_USERNAME }}/basic-nodejs-s2-image:latest
        
        - name: run unit test
          run: docker run ${{ secrets.DOCKERHUB_USERNAME }}/basic-nodejs-s2-image:latest npm test


  deploy:

        needs: ["test"]


        runs-on: ubuntu-latest

        steps:


          - name: connect to the VPS using SSH.
            uses: appleboy/ssh-action@master
            with:
              host: ${{ secrets.VPS_HOST }}
              username: ${{ secrets.VPS_USERNAME }}
              password:  ${{ secrets.VPS_PASSWORD }}
    
              script: | 

                  sudo docker pull ${{ secrets.DOCKERHUB_USERNAME }}/basic-nodejs-s2-image:latest
                  sudo docker images


    

